{% extends "base.html" %}
{% block title %}System Settings{% endblock %}
{% block content %}
<div class="container max-w-4xl mx-auto">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
    <h2 class="text-2xl font-bold mb-2 md:mb-0">System Settings</h2>
    <div class="flex flex-wrap gap-2">
      <button class="btn bg-blue-600 hover:bg-blue-700" onclick="checkNetworkConfig()">
        <span class="mr-2">üîç</span> Check Network Config
      </button>
      <button class="btn bg-purple-600 hover:bg-purple-700" onclick="scanAvailableIPs()">
        <span class="mr-2">üì°</span> Scan Available IPs
      </button>
      <button class="btn bg-green-600 hover:bg-green-700" onclick="testConnectivity()">
        <span class="mr-2">üåê</span> Test Connectivity
      </button>
    </div>
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Network Status -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-bold mb-4">Network Status</h3>
      <div id="networkStatus" class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span>Bridge Status:</span>
          <span id="bridgeStatus" class="font-mono">Checking...</span>
        </div>
        <div class="flex justify-between">
          <span>Interface Status:</span>
          <span id="interfaceStatus" class="font-mono">Checking...</span>
        </div>
        <div class="flex justify-between">
          <span>IP Forwarding:</span>
          <span id="ipForwarding" class="font-mono">Checking...</span>
        </div>
        <div class="flex justify-between">
          <span>NAT Rules:</span>
          <span id="natRules" class="font-mono">Checking...</span>
        </div>
      </div>
    </div>
    
    <!-- IP Pool Status -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-bold mb-4">IP Pool Status</h3>
      <div id="ipPoolStatus" class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span>Total IPs:</span>
          <span id="totalIps" class="font-mono">Loading...</span>
        </div>
        <div class="flex justify-between">
          <span>Used IPs:</span>
          <span id="usedIps" class="font-mono">Loading...</span>
        </div>
        <div class="flex justify-between">
          <span>Available IPs:</span>
          <span id="availableIpsCount" class="font-mono">Loading...</span>
        </div>
        <div class="flex justify-between">
          <span>Utilization:</span>
          <span id="utilization" class="font-mono">Loading...</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Configuration Form -->
  <div class="bg-white rounded-lg shadow p-6 mt-6">
    <h3 class="text-lg font-bold mb-4">Configuration</h3>
    <form method="post" class="flex flex-col gap-4">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="subnet_range" class="block font-medium mb-1">Subnet Range</label>
          <input type="text" name="subnet_range" value="{{ config.subnet_range }}" required placeholder="e.g. 203.0.113.0/24" class="border border-gray-300 rounded px-3 py-2 w-full">
        </div>
        <div>
          <label for="bridge_name" class="block font-medium mb-1">Bridge Name</label>
          <input type="text" name="bridge_name" value="{{ config.bridge_name }}" required placeholder="e.g. br0" class="border border-gray-300 rounded px-3 py-2 w-full">
        </div>
        <div>
          <label for="network_interface" class="block font-medium mb-1">Network Interface</label>
          <input type="text" name="network_interface" value="{{ config.network_interface }}" required placeholder="e.g. eth0" class="border border-gray-300 rounded px-3 py-2 w-full">
        </div>
        <div>
          <label for="max_containers" class="block font-medium mb-1">Max Containers</label>
          <input type="number" name="max_containers" value="{{ config.max_containers }}" min="1" max="254" required class="border border-gray-300 rounded px-3 py-2 w-full">
        </div>
        <div>
          <label for="default_cpu_limit" class="block font-medium mb-1">Default CPU Limit (cores)</label>
          <input type="number" step="0.01" name="default_cpu_limit" value="{{ config.default_cpu_limit }}" min="0.1" max="2.0" required class="border border-gray-300 rounded px-3 py-2 w-full">
        </div>
        <div>
          <label for="default_memory_limit" class="block font-medium mb-1">Default Memory Limit (MB)</label>
          <input type="number" name="default_memory_limit" value="{{ config.default_memory_limit // (1024*1024) }}" min="64" max="2048" required class="border border-gray-300 rounded px-3 py-2 w-full">
        </div>
      </div>
      <div class="flex items-center">
        <input type="checkbox" name="auto_assign_ips" id="auto_assign_ips" {% if config.auto_assign_ips %}checked{% endif %} class="mr-2">
        <label for="auto_assign_ips" class="font-medium">Auto-assign IPs</label>
      </div>
      <button class="btn w-full mt-4" type="submit">Save Configuration</button>
    </form>
  </div>
</div>

<script>
// Load initial status
document.addEventListener('DOMContentLoaded', function() {
    loadNetworkStatus();
    loadIPPoolStatus();
});

// Network Functions
function checkNetworkConfig() {
    loadNetworkStatus();
    fetch('/api/check-network')
        .then(response => response.json())
        .then(data => {
            let message = 'Network Configuration Check:\n\n';
            message += `Bridge: ${data.bridge_status}\n`;
            message += `Interface: ${data.interface_status}\n`;
            message += `IP Forwarding: ${data.ip_forwarding}\n`;
            message += `NAT Rules: ${data.nat_rules}\n`;
            alert(message);
        })
        .catch(error => {
            alert('Error checking network configuration');
        });
}

function scanAvailableIPs() {
    fetch('/api/scan-ips')
        .then(response => response.json())
        .then(data => {
            let message = 'IP Scan Results:\n\n';
            if (data.ips && data.ips.length > 0) {
                message += `Found ${data.ips.length} available IPs:\n`;
                message += data.ips.slice(0, 10).join('\n');
                if (data.ips.length > 10) {
                    message += `\n... and ${data.ips.length - 10} more`;
                }
            } else {
                message += 'No available IPs found';
            }
            alert(message);
        })
        .catch(error => {
            alert('Error scanning IPs');
        });
}

function testConnectivity() {
    fetch('/api/test-connectivity')
        .then(response => response.json())
        .then(data => {
            let message = 'Connectivity Test Results:\n\n';
            message += `Internet: ${data.internet ? '‚úÖ Connected' : '‚ùå Disconnected'}\n`;
            message += `DNS: ${data.dns ? '‚úÖ Working' : '‚ùå Failed'}\n`;
            message += `Gateway: ${data.gateway ? '‚úÖ Reachable' : '‚ùå Unreachable'}\n`;
            alert(message);
        })
        .catch(error => {
            alert('Error testing connectivity');
        });
}

function loadNetworkStatus() {
    fetch('/api/network-status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('bridgeStatus').textContent = data.bridge_status;
            document.getElementById('interfaceStatus').textContent = data.interface_status;
            document.getElementById('ipForwarding').textContent = data.ip_forwarding;
            document.getElementById('natRules').textContent = data.nat_rules;
        })
        .catch(error => {
            console.error('Error loading network status');
        });
}

function loadIPPoolStatus() {
    fetch('/api/ip-pool-status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalIps').textContent = data.total;
            document.getElementById('usedIps').textContent = data.used;
            document.getElementById('availableIpsCount').textContent = data.available;
            document.getElementById('utilization').textContent = data.utilization + '%';
        })
        .catch(error => {
            console.error('Error loading IP pool status');
        });
}
</script>
{% endblock %}
