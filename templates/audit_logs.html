{% extends "base.html" %}

{% block title %}Audit Logs - IP Gateway Admin{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Audit Logs</h1>
            <p class="mt-2 text-sm text-gray-600">Track all administrative actions and system events</p>
        </div>

        <!-- Filters -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Filters</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="action-filter" class="block text-sm font-medium text-gray-700">Action</label>
                        <select id="action-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="">All Actions</option>
                            <option value="user_created">User Created</option>
                            <option value="user_updated">User Updated</option>
                            <option value="user_deleted">User Deleted</option>
                            <option value="config_updated">Config Updated</option>
                            <option value="user_created_bulk">Bulk User Creation</option>
                        </select>
                    </div>
                    <div>
                        <label for="resource-filter" class="block text-sm font-medium text-gray-700">Resource Type</label>
                        <select id="resource-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="">All Resources</option>
                            <option value="user">User</option>
                            <option value="system">System</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div>
                        <label for="admin-filter" class="block text-sm font-medium text-gray-700">Admin</label>
                        <input type="text" id="admin-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Admin username">
                    </div>
                    <div class="flex items-end">
                        <button id="apply-filters" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Activity Log</h3>
                    <div class="flex items-center space-x-3">
                        <span id="loading-indicator" class="hidden text-sm text-gray-500">Loading...</span>
                        <button id="refresh-logs" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" aria-label="Refresh audit logs">
                            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <div id="logs-container">
                <!-- Logs will be loaded here -->
            </div>

            <!-- Pagination -->
            <div id="pagination-container" class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                <!-- Pagination content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div id="log-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Log Details</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="log-details" class="text-sm text-gray-600">
                <!-- Log details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentFilters = {};

    loadLogs();

    // Event listeners
    document.getElementById('apply-filters').addEventListener('click', function() {
        currentFilters = {
            action: document.getElementById('action-filter').value,
            resource_type: document.getElementById('resource-filter').value,
            admin: document.getElementById('admin-filter').value
        };
        currentPage = 1;
        loadLogs();
    });

    document.getElementById('refresh-logs').addEventListener('click', function() {
        loadLogs();
    });

    document.getElementById('close-modal').addEventListener('click', function() {
        document.getElementById('log-modal').classList.add('hidden');
    });

    function loadLogs() {
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.classList.remove('hidden');

        const params = new URLSearchParams({
            page: currentPage,
            per_page: 50,
            ...currentFilters
        });

        fetch(`/api/audit-logs?${params}`)
            .then(response => response.json())
            .then(data => {
                renderLogs(data.logs);
                renderPagination(data.pagination);
                loadingIndicator.classList.add('hidden');
            })
            .catch(error => {
                console.error('Error loading logs:', error);
                loadingIndicator.classList.add('hidden');
                showToast('Failed to load audit logs', 'error');
            });
    }

    function renderLogs(logs) {
        const container = document.getElementById('logs-container');

        if (logs.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No logs found</h3>
                    <p class="mt-1 text-sm text-gray-500">No audit logs match your current filters.</p>
                </div>
            `;
            return;
        }

        const logsHtml = logs.map(log => `
            <div class="border-b border-gray-200 hover:bg-gray-50 cursor-pointer" onclick="showLogDetails(${log.id})">
                <div class="px-4 py-4 sm:px-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${log.admin_username}</div>
                                <div class="text-sm text-gray-500">${formatAction(log.action)}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-900">${formatTimestamp(log.timestamp)}</div>
                            <div class="text-sm text-gray-500">${log.ip_address}</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div class="text-sm text-gray-600">
                            <span class="font-medium">${log.resource_type}:</span> ${log.resource_id || 'N/A'}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        container.innerHTML = logsHtml;
    }

    function renderPagination(pagination) {
        const container = document.getElementById('pagination-container');

        if (pagination.pages <= 1) {
            container.innerHTML = '';
            return;
        }

        let paginationHtml = `
            <div class="flex-1 flex justify-between sm:hidden">
                <button onclick="changePage(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''} class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 ${pagination.page <= 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                    Previous
                </button>
                <button onclick="changePage(${pagination.page + 1})" ${pagination.page >= pagination.pages ? 'disabled' : ''} class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 ${pagination.page >= pagination.pages ? 'opacity-50 cursor-not-allowed' : ''}">
                    Next
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">${(pagination.page - 1) * pagination.per_page + 1}</span>
                        to <span class="font-medium">${Math.min(pagination.page * pagination.per_page, pagination.total)}</span>
                        of <span class="font-medium">${pagination.total}</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
        `;

        // Previous button
        paginationHtml += `
            <button onclick="changePage(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''} class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${pagination.page <= 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
            </button>
        `;

        // Page numbers
        const startPage = Math.max(1, pagination.page - 2);
        const endPage = Math.min(pagination.pages, pagination.page + 2);

        for (let i = startPage; i <= endPage; i++) {
            paginationHtml += `
                <button onclick="changePage(${i})" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium ${i === pagination.page ? 'text-indigo-600 bg-indigo-50 border-indigo-500' : 'text-gray-700 hover:bg-gray-50'}">
                    ${i}
                </button>
            `;
        }

        // Next button
        paginationHtml += `
            <button onclick="changePage(${pagination.page + 1})" ${pagination.page >= pagination.pages ? 'disabled' : ''} class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${pagination.page >= pagination.pages ? 'opacity-50 cursor-not-allowed' : ''}">
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
            </button>
        `;

        paginationHtml += `
                    </nav>
                </div>
            </div>
        `;

        container.innerHTML = paginationHtml;
    }

    window.changePage = function(page) {
        currentPage = page;
        loadLogs();
    };

    window.showLogDetails = function(logId) {
        // For now, just show a simple alert. In a real implementation,
        // you'd fetch detailed log information
        fetch(`/api/audit-logs?page=1&per_page=1`)
            .then(response => response.json())
            .then(data => {
                const log = data.logs.find(l => l.id === logId);
                if (log) {
                    const detailsHtml = `
                        <div class="space-y-3">
                            <div><strong>Timestamp:</strong> ${formatTimestamp(log.timestamp)}</div>
                            <div><strong>Admin:</strong> ${log.admin_username}</div>
                            <div><strong>Action:</strong> ${formatAction(log.action)}</div>
                            <div><strong>Resource Type:</strong> ${log.resource_type}</div>
                            <div><strong>Resource ID:</strong> ${log.resource_id || 'N/A'}</div>
                            <div><strong>IP Address:</strong> ${log.ip_address}</div>
                            <div><strong>User Agent:</strong> ${log.user_agent || 'N/A'}</div>
                            ${log.details ? `<div><strong>Details:</strong> <pre class="mt-1 text-xs bg-gray-100 p-2 rounded">${log.details}</pre></div>` : ''}
                        </div>
                    `;
                    document.getElementById('log-details').innerHTML = detailsHtml;
                    document.getElementById('log-modal').classList.remove('hidden');
                }
            });
    };

    function formatAction(action) {
        const actionMap = {
            'user_created': 'Created User',
            'user_updated': 'Updated User',
            'user_deleted': 'Deleted User',
            'config_updated': 'Updated Configuration',
            'user_created_bulk': 'Bulk Created Users'
        };
        return actionMap[action] || action.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString();
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
});
</script>
{% endblock %}
