{% extends "base.html" %}

{% block title %}Bulk Operations - IP Gateway Admin{% endblock %}

{% block page_title %}Bulk User Operations{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- CSV Import Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Bulk User Import (CSV)</h3>

            <!-- CSV Format Instructions -->
            <div class="mb-6 bg-blue-50 border border-blue-200 rounded-md p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h4 class="text-sm font-medium text-blue-800">CSV Format Requirements</h4>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>Your CSV file must include these columns:</p>
                            <ul class="mt-1 list-disc list-inside space-y-1">
                                <li><code>username</code> - Required: Unique username (alphanumeric, underscore, dash)</li>
                                <li><code>password</code> - Required: User password (minimum 6 characters)</li>
                                <li><code>ip_address</code> - Required: Valid IP address in subnet range</li>
                                <li><code>enable_ssh</code> - Optional: true/false (default: true)</li>
                                <li><code>enable_socks5</code> - Optional: true/false (default: false)</li>
                                <li><code>enable_http</code> - Optional: true/false (default: false)</li>
                                <li><code>enable_pptp</code> - Optional: true/false (default: false)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSV Upload Form -->
            <form id="csv-upload-form" class="space-y-4">
                <div>
                    <label for="csv-file" class="block text-sm font-medium text-gray-700">CSV File</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="csv-file" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                    <span>Upload a CSV file</span>
                                    <input id="csv-file" name="csv-file" type="file" accept=".csv" class="sr-only">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">CSV up to 10MB</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button type="submit" id="upload-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Upload & Import
                    </button>
                </div>
            </form>

            <!-- Upload Progress -->
            <div id="upload-progress" class="hidden mt-4">
                <div class="bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-600 mt-2">Processing...</p>
            </div>
        </div>
    </div>

    <!-- CSV Export Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Export Users (CSV)</h3>
            <p class="text-sm text-gray-600 mb-4">
                Download all user data in CSV format for backup or analysis.
            </p>

            <div class="flex space-x-4">
                <button id="export-all-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export All Users
                </button>

                <button id="export-active-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export Active Users
                </button>
            </div>
        </div>
    </div>

    <!-- Sample CSV Template -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">CSV Template</h3>
            <p class="text-sm text-gray-600 mb-4">
                Download a sample CSV template to get started with bulk user creation.
            </p>

            <button id="download-template-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Download Template
            </button>

            <!-- Sample Data Preview -->
            <div class="mt-6">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Sample CSV Content:</h4>
                <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                    <pre class="text-xs text-gray-800 overflow-x-auto"><code>username,password,ip_address,enable_ssh,enable_socks5,enable_http,enable_pptp
john_doe,securepass123,192.168.1.10,true,true,false,false
jane_smith,mypassword456,192.168.1.11,true,false,true,true
bob_wilson,pass789word,192.168.1.12,false,true,true,false</code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Results Modal -->
    <div id="results-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white max-h-96 overflow-y-auto">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Import Results</h3>
                    <button id="close-results-modal" class="text-gray-400 hover:text-gray-600" aria-label="Close modal">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="results-content">
                    <!-- Results will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csvUploadForm = document.getElementById('csv-upload-form');
    const csvFileInput = document.getElementById('csv-file');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const resultsModal = document.getElementById('results-modal');
    const resultsContent = document.getElementById('results-content');

    // CSV Upload
    csvUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const file = csvFileInput.files[0];
        if (!file) {
            showToast('Please select a CSV file', 'error');
            return;
        }

        if (!file.name.endsWith('.csv')) {
            showToast('Please select a valid CSV file', 'error');
            return;
        }

        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            showToast('File size must be less than 10MB', 'error');
            return;
        }

        uploadFile(file);
    });

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('csv_file', file);

        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';
        uploadProgress.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = 'Reading file...';

        // Read file content
        const reader = new FileReader();
        reader.onload = function(e) {
            const csvContent = e.target.result;
            processCSV(csvContent);
        };
        reader.readAsText(file);
    }

    function processCSV(csvContent) {
        progressText.textContent = 'Processing CSV data...';

        fetch('/api/users/bulk', {
            method: 'POST',
            body: new URLSearchParams({
                'csv_data': csvContent
            }),
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            displayResults(data);
            uploadProgress.classList.add('hidden');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = `
                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Upload & Import
            `;
        })
        .catch(error => {
            console.error('Error processing CSV:', error);
            showToast('Failed to process CSV file', 'error');
            uploadProgress.classList.add('hidden');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = `
                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Upload & Import
            `;
        });
    }

    function displayResults(data) {
        let html = '<div class="space-y-4">';

        if (data.created && data.created.length > 0) {
            html += `
                <div class="bg-green-50 border border-green-200 rounded-md p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-green-800">Successfully Created Users (${data.created.length})</h4>
                            <div class="mt-2 text-sm text-green-700">
                                <ul class="list-disc list-inside space-y-1">
                                    ${data.created.map(user => `<li>${user.username} (${user.ip_address})</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        if (data.errors && data.errors.length > 0) {
            html += `
                <div class="bg-red-50 border border-red-200 rounded-md p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-red-800">Import Errors (${data.errors.length})</h4>
                            <div class="mt-2 text-sm text-red-700">
                                <ul class="list-disc list-inside space-y-1">
                                    ${data.errors.map(error => `<li>${error}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        html += '</div>';
        resultsContent.innerHTML = html;
        resultsModal.classList.remove('hidden');
    }

    // Export functions
    document.getElementById('export-all-btn').addEventListener('click', function() {
        exportUsers('all');
    });

    document.getElementById('export-active-btn').addEventListener('click', function() {
        exportUsers('active');
    });

    document.getElementById('download-template-btn').addEventListener('click', function() {
        downloadTemplate();
    });

    function exportUsers(filter) {
        // This would typically call an API endpoint to get user data
        // For now, we'll create a simple CSV with sample data
        const csvContent = "username,password,ip_address,enable_ssh,enable_socks5,enable_http,enable_pptp\njohn_doe,securepass123,192.168.1.10,true,true,false,false\njane_smith,mypassword456,192.168.1.11,true,false,true,true\n";

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `users_${filter}_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showToast('CSV export completed', 'success');
    }

    function downloadTemplate() {
        const templateContent = "username,password,ip_address,enable_ssh,enable_socks5,enable_http,enable_pptp\nuser1,password123,192.168.1.10,true,false,false,false\nuser2,password456,192.168.1.11,true,true,true,false\n";

        const blob = new Blob([templateContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'bulk_import_template.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showToast('Template downloaded', 'success');
    }

    // Modal close
    document.getElementById('close-results-modal').addEventListener('click', function() {
        resultsModal.classList.add('hidden');
    });

    // File drag and drop
    const dropZone = csvUploadForm.querySelector('.border-dashed');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
    }

    function unhighlight(e) {
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            csvFileInput.files = files;
            // Trigger change event
            const event = new Event('change');
            csvFileInput.dispatchEvent(event);
        }
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
});
</script>
{% endblock %}
