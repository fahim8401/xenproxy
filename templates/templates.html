{% extends "base.html" %}
{% block title %}LXC Templates{% endblock %}
{% block page_title %}LXC Templates{% endblock %}
{% block content %}
<div class="container">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
    <h2 class="text-2xl font-bold mb-2 md:mb-0">LXC Templates</h2>
    <div class="flex flex-wrap gap-2">
      <button class="btn bg-green-600 hover:bg-green-700" onclick="showCreateTemplateModal()">
        <span class="mr-2">‚ûï</span> Create Template
      </button>
      <a href="{{ url_for('containers') }}" class="btn">Back to Containers</a>
    </div>
  </div>

  <div class="search-filter bg-gray-50 p-3 rounded mb-4">
    <input type="text" id="search" placeholder="Search templates..." class="w-full border border-gray-300 rounded px-3 py-2">
  </div>

  <div class="overflow-x-auto rounded shadow">
    <table class="admin-table min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2">Name</th>
          <th class="px-4 py-2">Description</th>
          <th class="px-4 py-2">Default</th>
          <th class="px-4 py-2">Created</th>
          <th class="px-4 py-2">Updated</th>
          <th class="px-4 py-2">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" id="templates-table-body">
        {% for template in templates %}
        <tr class="template-row" data-template-id="{{ template.id }}">
          <td class="px-4 py-2 font-medium">{{ template.name }}</td>
          <td class="px-4 py-2">{{ template.description or 'No description' }}</td>
          <td class="px-4 py-2">
            {% if template.is_default %}
              <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Default</span>
            {% else %}
              <span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">No</span>
            {% endif %}
          </td>
          <td class="px-4 py-2 text-sm text-gray-600">{{ template.created_at.strftime('%Y-%m-%d %H:%M') if template.created_at else 'N/A' }}</td>
          <td class="px-4 py-2 text-sm text-gray-600">{{ template.updated_at.strftime('%Y-%m-%d %H:%M') if template.updated_at else 'N/A' }}</td>
          <td class="px-4 py-2">
            <div class="flex gap-1">
              <button class="btn btn-sm bg-blue-500 hover:bg-blue-600" onclick="editTemplate({{ template.id }})">
                <span class="mr-1">‚úèÔ∏è</span> Edit
              </button>
              <button class="btn btn-sm bg-purple-500 hover:bg-purple-600" onclick="duplicateTemplate({{ template.id }})">
                <span class="mr-1">üìã</span> Copy
              </button>
              {% if not template.is_default %}
              <button class="btn btn-sm bg-red-500 hover:bg-red-600" onclick="deleteTemplate({{ template.id }}, '{{ template.name }}')">
                <span class="mr-1">üóëÔ∏è</span> Delete
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if templates|length == 0 %}
  <div class="text-center py-8 text-gray-500">
    <p>No templates found. Create your first template to get started.</p>
  </div>
  {% endif %}
</div>

<!-- Create/Edit Template Modal -->
<div id="template-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900" id="modal-title">Create Template</h3>
        <button onclick="closeTemplateModal()" class="text-gray-400 hover:text-gray-600">
          <span class="text-2xl">&times;</span>
        </button>
      </div>

      <form id="template-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" id="template-id" name="template_id">

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Template Name *</label>
          <input type="text" id="template-name" name="name" required
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
          <textarea id="template-description" name="description" rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Configuration Content *</label>
          <textarea id="template-config" name="config_content" rows="15" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                    placeholder="Enter LXC configuration content here..."></textarea>
          <p class="text-xs text-gray-500 mt-1">Use variables like {{container_name}}, {{username}}, {{ip_address}}, {{bridge_name}}, etc.</p>
        </div>

        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="template-default" name="is_default" class="mr-2">
            <span class="text-sm font-medium text-gray-700">Set as default template</span>
          </label>
        </div>

        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeTemplateModal()" class="btn bg-gray-500 hover:bg-gray-600">
            Cancel
          </button>
          <button type="submit" class="btn bg-blue-600 hover:bg-blue-700" id="save-template-btn">
            Save Template
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Template management functions
let currentTemplateId = null;

function showCreateTemplateModal() {
  document.getElementById('modal-title').textContent = 'Create Template';
  document.getElementById('template-form').reset();
  document.getElementById('template-id').value = '';
  currentTemplateId = null;
  document.getElementById('template-modal').classList.remove('hidden');
}

function editTemplate(templateId) {
  currentTemplateId = templateId;
  document.getElementById('modal-title').textContent = 'Edit Template';

  // Fetch template data
  fetch(`/api/templates/${templateId}`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('template-id').value = data.id;
      document.getElementById('template-name').value = data.name;
      document.getElementById('template-description').value = data.description || '';
      document.getElementById('template-config').value = data.config_content;
      document.getElementById('template-default').checked = data.is_default;
      document.getElementById('template-modal').classList.remove('hidden');
    })
    .catch(error => {
      console.error('Error fetching template:', error);
      alert('Error loading template data');
    });
}

function closeTemplateModal() {
  document.getElementById('template-modal').classList.add('hidden');
  document.getElementById('template-form').reset();
  currentTemplateId = null;
}

function duplicateTemplate(templateId) {
  if (confirm('Are you sure you want to duplicate this template?')) {
    fetch(`/api/templates/${templateId}/duplicate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
      } else {
        location.reload();
      }
    })
    .catch(error => {
      console.error('Error duplicating template:', error);
      alert('Error duplicating template');
    });
  }
}

function deleteTemplate(templateId, templateName) {
  if (confirm(`Are you sure you want to delete the template "${templateName}"? This action cannot be undone.`)) {
    fetch(`/api/templates/${templateId}`, {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
      } else {
        location.reload();
      }
    })
    .catch(error => {
      console.error('Error deleting template:', error);
      alert('Error deleting template');
    });
  }
}

// Form submission
document.getElementById('template-form').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData(this);
  const data = {
    name: formData.get('name'),
    description: formData.get('description'),
    config_content: formData.get('config_content'),
    is_default: formData.get('is_default') === 'on'
  };

  const method = currentTemplateId ? 'PUT' : 'POST';
  const url = currentTemplateId ? `/api/templates/${currentTemplateId}` : '/api/templates';

  document.getElementById('save-template-btn').disabled = true;
  document.getElementById('save-template-btn').textContent = 'Saving...';

  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert('Error: ' + data.error);
    } else {
      location.reload();
    }
  })
  .catch(error => {
    console.error('Error saving template:', error);
    alert('Error saving template');
  })
  .finally(() => {
    document.getElementById('save-template-btn').disabled = false;
    document.getElementById('save-template-btn').textContent = 'Save Template';
  });
});

// Search functionality
document.getElementById('search').addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  const rows = document.querySelectorAll('.template-row');

  rows.forEach(row => {
    const name = row.cells[0].textContent.toLowerCase();
    const description = row.cells[1].textContent.toLowerCase();

    if (name.includes(searchTerm) || description.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});
</script>
{% endblock %}