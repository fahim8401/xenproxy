{% extends "base.html" %}
{% block title %}Containers{% endblock %}
{% block content %}
<div class="container">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
    <h2 class="text-2xl font-bold mb-2 md:mb-0">Containers</h2>
    <div class="flex flex-wrap gap-2">
      <button class="btn bg-blue-600 hover:bg-blue-700" onclick="showIpManagementModal()">
        <span class="mr-2">üåê</span> IP Management
      </button>
      <button class="btn bg-purple-600 hover:bg-purple-700" onclick="checkNetworkConfig()">
        <span class="mr-2">üîç</span> Check Network
      </button>
      <button class="btn bg-indigo-600 hover:bg-indigo-700" onclick="scanAvailableIPs()">
        <span class="mr-2">üì°</span> Scan IPs
      </button>
      <a href="{{ url_for('dashboard') }}" class="btn">Back to Dashboard</a>
      <button class="btn bg-green-600 hover:bg-green-700" id="create-container-btn">+ Create New Container</button>
    </div>
  </div>
  <div class="search-filter bg-gray-50 p-3 rounded mb-4 flex flex-col md:flex-row gap-2 md:gap-4">
    <input type="text" id="search" placeholder="Search by username or IP" class="flex-1 border border-gray-300 rounded px-3 py-2">
    <select id="status-filter" class="border border-gray-300 rounded px-3 py-2">
      <option value="">All Status</option>
      <option value="running">Running</option>
      <option value="stopped">Stopped</option>
      <option value="creating">Creating</option>
    </select>
    <select id="protocol-filter" class="border border-gray-300 rounded px-3 py-2">
      <option value="">All Protocols</option>
      <option value="ssh">SSH</option>
      <option value="socks5">SOCKS5</option>
      <option value="http">HTTP</option>
      <option value="wireguard">WireGuard</option>
    </select>
  </div>
  <!-- <form id="bulk-actions-form" method="post"> -->
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="overflow-x-auto rounded shadow">
      <table class="admin-table min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2"><input type="checkbox" id="select-all"></th>
            <th class="px-4 py-2">Username</th>
            <th class="px-4 py-2">IP Address</th>
            <th class="px-4 py-2">Auth</th>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Protocols</th>
            <th class="px-4 py-2">Bandwidth</th>
            <th class="px-4 py-2">Health</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="container-table-body" class="bg-white divide-y divide-gray-100">
          {% for c in containers %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2"><input type="checkbox" name="selected" value="{{ c.container_name }}"></td>
            <td class="px-4 py-2 font-semibold">{{ c.username }}</td>
            <td class="px-4 py-2">{{ c.ip_address }}</td>
            <td class="px-4 py-2">
              {% if c.ssh_public_key %}
                <span class="text-blue-600">SSH</span>
              {% elif c.password %}
                <span class="text-green-600">PWD</span>
              {% else %}
                <span class="text-gray-400">-</span>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% if c.status == 'running' %}
                <span class="status-dot running"></span> <span class="text-green-700 font-medium">Running</span>
              {% elif c.status == 'stopped' %}
                <span class="status-dot stopped"></span> <span class="text-red-700 font-medium">Stopped</span>
              {% else %}
                <span class="status-dot creating"></span> <span class="text-yellow-700 font-medium">Creating</span>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% if c.enable_ssh %}<span title="SSH">üîí</span>{% endif %}
              {% if c.enable_socks5 %}<span title="SOCKS5">üß¶</span>{% endif %}
              {% if c.enable_http %}<span title="HTTP">üåê</span>{% endif %}
              {% if c.enable_wireguard %}<span title="WireGuard">üõ°Ô∏è</span>{% endif %}
            </td>
            <td class="px-4 py-2">{{ (c.bandwidth_in + c.bandwidth_out) // (1024*1024) }} MB</td>
            <td class="px-4 py-2">
              {% if c.health_status == 'healthy' %}
                <span class="health-dot healthy"></span> <span class="text-green-700 font-medium">Healthy</span>
              {% elif c.health_status == 'degraded' %}
                <span class="health-dot degraded"></span> <span class="text-yellow-700 font-medium">Degraded</span>
              {% else %}
                <span class="health-dot failed"></span> <span class="text-red-700 font-medium">Failed</span>
              {% endif %}
            </td>
            <td class="px-4 py-2 space-x-1">
              <a href="{{ url_for('container_detail', name=c.container_name) }}" class="btn btn-small">View</a>
              <a href="{{ url_for('edit_container_page', name=c.container_name) }}" class="btn btn-small bg-blue-600 hover:bg-blue-700">Edit</a>
              <form action="{{ url_for('start_container_route', name=c.container_name) }}" method="post" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-small" type="submit">Start</button>
              </form>
              <form action="{{ url_for('stop_container_route', name=c.container_name) }}" method="post" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-small" type="submit">Stop</button>
              </form>
              <form action="{{ url_for('delete_container_route', name=c.container_name) }}" method="post" class="inline" onsubmit="return confirm('Delete this container?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-small btn-danger" type="submit">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Bulk actions not implemented -->
  <!-- </form> -->
</div>

<!-- IP Management Modal -->
<div id="ipModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
      <div class="p-6">
        <h3 class="text-lg font-bold mb-4">IP Address Management</h3>
        
        <!-- Single IP Add -->
        <div class="mb-4">
          <h4 class="font-semibold mb-2">Add Single IP</h4>
          <form id="singleIpForm" class="flex gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" id="singleIp" placeholder="192.168.1.10" class="flex-1 border border-gray-300 rounded px-3 py-2" required>
            <button type="submit" class="btn bg-green-600 hover:bg-green-700">Add IP</button>
          </form>
        </div>
        
        <!-- Batch IP Add -->
        <div class="mb-4">
          <h4 class="font-semibold mb-2">Add Batch IPs</h4>
          <form id="batchIpForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <textarea id="batchIps" placeholder="192.168.1.10&#10;192.168.1.11&#10;192.168.1.12" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 mb-2" required></textarea>
            <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 w-full">Add Batch IPs</button>
          </form>
        </div>
        
        <!-- IP List -->
        <div class="mb-4">
          <h4 class="font-semibold mb-2">Available IPs</h4>
          <div id="availableIps" class="max-h-32 overflow-y-auto border border-gray-300 rounded p-2 text-sm">
            Loading...
          </div>
        </div>
        
        <div class="flex justify-end gap-2">
          <button onclick="closeIpModal()" class="btn bg-gray-500 hover:bg-gray-600">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// IP Management Functions
function showIpManagementModal() {
    document.getElementById('ipModal').classList.remove('hidden');
    loadAvailableIPs();
}

function closeIpModal() {
    document.getElementById('ipModal').classList.add('hidden');
}

function loadAvailableIPs() {
    fetch('/api/available-ips')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('availableIps');
            if (data.ips && data.ips.length > 0) {
                container.innerHTML = data.ips.map(ip => `<div class="py-1">${ip}</div>`).join('');
            } else {
                container.innerHTML = '<div class="text-gray-500">No available IPs found</div>';
            }
        })
        .catch(error => {
            document.getElementById('availableIps').innerHTML = '<div class="text-red-500">Error loading IPs</div>';
        });
}

// Single IP Form
document.getElementById('singleIpForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const ip = document.getElementById('singleIp').value;
    
    fetch('/api/add-ip', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ip: ip })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('IP added successfully!');
            document.getElementById('singleIp').value = '';
            loadAvailableIPs();
        } else {
            alert('Error: ' + data.message);
        }
    });
});

// Batch IP Form
document.getElementById('batchIpForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const ips = document.getElementById('batchIps').value.split('\n').map(ip => ip.trim()).filter(ip => ip);
    
    fetch('/api/add-batch-ips', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ips: ips })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.added_count} IPs added successfully!`);
            document.getElementById('batchIps').value = '';
            loadAvailableIPs();
        } else {
            alert('Error: ' + data.message);
        }
    });
});

// Network Functions
function checkNetworkConfig() {
    fetch('/api/check-network')
        .then(response => response.json())
        .then(data => {
            let message = 'Network Configuration Check:\n\n';
            message += `Bridge: ${data.bridge_status}\n`;
            message += `Interface: ${data.interface_status}\n`;
            message += `IP Forwarding: ${data.ip_forwarding}\n`;
            message += `NAT Rules: ${data.nat_rules}\n`;
            alert(message);
        })
        .catch(error => {
            alert('Error checking network configuration');
        });
}

function scanAvailableIPs() {
    document.getElementById('availableIps').innerHTML = 'Scanning...';
    fetch('/api/scan-ips')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('availableIps');
            if (data.ips && data.ips.length > 0) {
                container.innerHTML = data.ips.map(ip => `<div class="py-1">${ip} (available)</div>`).join('');
            } else {
                container.innerHTML = '<div class="text-gray-500">No available IPs found</div>';
            }
        })
        .catch(error => {
            document.getElementById('availableIps').innerHTML = '<div class="text-red-500">Error scanning IPs</div>';
        });
}
</script>
{% endblock %}
